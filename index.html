<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阿彬日記 (iOS Style)</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 配置 Tailwind CSS (模擬 Apple System Fonts & Colors) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: [
                '-apple-system', 
                'BlinkMacSystemFont', 
                'San Francisco', 
                'Helvetica Neue', 
                'Inter', 
                'Noto Sans TC', 
                'sans-serif'
              ],
            },
            colors: {
              ios: {
                bg: '#F2F2F7',      // System Grouped Background
                card: '#FFFFFF',    // Secondary System Grouped Background
                blue: '#007AFF',    // System Blue
                green: '#34C759',   // System Green
                red: '#FF3B30',     // System Red
                gray: '#8E8E93',    // System Gray
                gray2: '#AEAEB2',   // System Gray 2
                gray3: '#C7C7CC',   // System Gray 3
                gray4: '#D1D1D6',   // System Gray 4
                gray5: '#E5E5EA',   // System Gray 5
                gray6: '#F2F2F7',   // System Gray 6
                separator: '#C6C6C8',
                orange: '#FF9500',  // System Orange
                purple: '#AF52DE',  // System Purple
                indigo: '#5856D6',  // System Indigo
              }
            },
            boxShadow: {
              'ios-card': '0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02)',
              'ios-float': '0 8px 24px rgba(0, 0, 0, 0.12)',
              'ios-modal': '0 20px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0,0,0,0.05)',
            },
            animation: {
              'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'scale-in': 'scaleIn 0.25s cubic-bezier(0.16, 1, 0.3, 1)',
            },
            keyframes: {
              slideUp: {
                '0%': { transform: 'translateY(20px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              scaleIn: {
                '0%': { transform: 'scale(0.95)', opacity: '0' },
                '100%': { transform: 'scale(1)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #F2F2F7; /* iOS Base Background */
      }
      /* 隱藏滾動條但保持功能 */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* iOS Input Style Override */
      .ios-input-shadow {
        box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    
    // --- SF Symbols Style Icons ---
    const Plus = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    );
    const Trash2 = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
    );
    const RefreshCw = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.5 15a9 9 0 0 1 14.8-8.2l-2.4 2.3"></path><path d="M20.5 9a9 9 0 0 1-14.8 8.2l2.4-2.3"></path></svg>
    );
    const AlertCircle = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
    );
    const Settings = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    );
    const Key = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
    );
    const BarChart2 = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
    );
    const Sparkles = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>
    );
    const Brain = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 16v-4"></path><path d="M12 8h.01"></path><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>
    );
    const ChevronDown = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>
    );
    const ShieldAlert = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
    );
    const Target = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
    );
    const List = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
    );
    const Clock = ({ size = 20, className = "" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    );

    // --- Gemini API & Utilities ---
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

    const fetchWithBackoff = async (url, options, maxRetries = 5) => {
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          if (attempt === maxRetries - 1) throw error;
          const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    };

    const callGeminiApi = async (userApiKey, userQuery, systemPrompt, useSearch = false) => {
        let finalKey = userApiKey;
        if (!finalKey && typeof API_KEY !== 'undefined') {
            finalKey = API_KEY;
        }
        if (!finalKey) throw new Error("請先設定 Gemini API Key");
        
        const url = GEMINI_API_URL + finalKey;
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        if (useSearch) payload.tools = [{ "google_search": {} }];

        const response = await fetchWithBackoff(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const candidate = response.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
            const text = candidate.content.parts[0].text;
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(a => ({ uri: a.web?.uri, title: a.web?.title }))
                    .filter(s => s.uri && s.title);
            }
            return { text, sources };
        }
        throw new Error("Gemini API returned no content.");
    };

    // --- Technical Indicators Logic ---
    const lastValid = (arr) => {
      if (!arr || !arr.length) return null;
      for (let i = arr.length - 1; i >= 0; i--) {
        if (typeof arr[i] === "number" && !isNaN(arr[i])) return arr[i];
      }
      return null;
    };
    const avgTail = (arr, n) => {
      const a = arr.slice(-n).filter(x => typeof x === "number" && !isNaN(x));
      if (!a.length) return 0;
      return a.reduce((p, c) => p + c, 0) / a.length;
    };
    const calcRSI = (closes, len) => {
      if (closes.length < len + 1) return 50;
      let g = 0, l = 0;
      for (let i = closes.length - (len + 1); i < closes.length - 1; i++) {
        const d = closes[i + 1] - closes[i];
        if (d > 0) g += d; else l -= d;
      }
      const ag = g / len, al = l / len;
      const rs = (al === 0) ? 100 : ag / al;
      return 100 - (100 / (1 + rs));
    };
    const emaSeries = (arr, span) => {
      if (arr.length === 0) return [];
      const k = 2 / (span + 1);
      let e = arr[0];
      const out = [e];
      for (let i = 1; i < arr.length; i++) {
        e = arr[i] * k + e * (1 - k);
        out.push(e);
      }
      return out;
    };
    const calcMACD = (closes) => {
      if (closes.length < 35) return { macd: 0, signal: 0, hist: 0 };
      const ema12 = emaSeries(closes, 12);
      const ema26 = emaSeries(closes, 26);
      const validMacdLine = [];
      for(let i=0; i<closes.length; i++) {
          if(i < 25) { validMacdLine.push(0); } 
          else { validMacdLine.push(ema12[i] - (ema26[i] || 0)); }
      }
      const signalLine = emaSeries(validMacdLine, 9);
      const macd = validMacdLine.at(-1);
      const signal = signalLine.at(-1);
      return { macd, signal, hist: macd - signal };
    };
    const lastPivotHigh = (highs, lb = 5) => {
      for (let i = highs.length - lb - 1; i >= lb; i--) {
        let ok = true;
        for (let k = 1; k <= lb; k++) {
          if (highs[i] <= highs[i - k] || highs[i] <= highs[i + k]) { ok = false; break; }
        }
        if (ok) return highs[i];
      }
      return null;
    };
    const lastPivotLow = (lows, lb = 5) => {
      for (let i = lows.length - lb - 1; i >= lb; i--) {
        let ok = true;
        for (let k = 1; k <= lb; k++) {
          if (lows[i] >= lows[i - k] || lows[i] >= lows[i + k]) { ok = false; break; }
        }
        if (ok) return lows[i];
      }
      return null;
    };
    const detectFalseBreakout = (highs, lows, closes, vols, tol = 0.001, volMul = 1.2) => {
      const safeMax = highs.slice(-20).length > 0 ? Math.max(...highs.slice(-20)) : 0;
      const safeMin = lows.slice(-20).length > 0 ? Math.min(...lows.slice(-20)) : 0;
      const res = lastPivotHigh(highs) ?? safeMax;
      const sup = lastPivotLow(lows) ?? safeMin;
      const h = highs.at(-1), l = lows.at(-1), c = closes.at(-1);
      const v = vols.at(-1) || 0, avgV = avgTail(vols, 10);
      const bear = (h > res * (1 + tol)) && (c < res) && (v < avgV * volMul);
      const bull = (l < sup * (1 - tol)) && (c > sup) && (v < avgV * volMul);
      return { bear, bull };
    };

    // --- Candlestick Chart ---
    const CandlestickChart = ({ data }) => {
        if (!data || data.closes.length === 0) return null;
        const count = data.closes.length;
        const displayCount = Math.min(count, 40);
        const startIndex = count - displayCount;
        const slicedOpens = data.opens.slice(startIndex);
        const slicedHighs = data.highs.slice(startIndex);
        const slicedLows = data.lows.slice(startIndex);
        const slicedCloses = data.closes.slice(startIndex);

        const maxPrice = Math.max(...slicedHighs);
        const minPrice = Math.min(...slicedLows);
        const range = maxPrice - minPrice || 1;
        const padding = range * 0.1;
        const plotMax = maxPrice + padding;
        const plotMin = minPrice - padding;
        const plotRange = plotMax - plotMin;

        const chartW = 300;
        const chartH = 150;
        const candleWidth = (chartW / displayCount) * 0.5;
        const spacing = chartW / displayCount;

        return (
            <div className="w-full h-40 mt-2 relative">
                <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full h-full" preserveAspectRatio="none">
                    {[0.2, 0.4, 0.6, 0.8].map(p => (
                        <line key={p} x1="0" y1={chartH * p} x2={chartW} y2={chartH * p} stroke="#E5E5EA" strokeWidth="1" strokeDasharray="3 3" />
                    ))}

                    {slicedCloses.map((close, i) => {
                        const open = slicedOpens[i];
                        const high = slicedHighs[i];
                        const low = slicedLows[i];
                        const x = i * spacing + (spacing - candleWidth) / 2;
                        const yHigh = chartH - ((high - plotMin) / plotRange) * chartH;
                        const yLow = chartH - ((low - plotMin) / plotRange) * chartH;
                        const yOpen = chartH - ((open - plotMin) / plotRange) * chartH;
                        const yClose = chartH - ((close - plotMin) / plotRange) * chartH;
                        
                        const isUp = close >= open;
                        const displayColor = isUp ? "#FF3B30" : "#34C759"; 

                        const barTop = Math.min(yOpen, yClose);
                        const barHeight = Math.abs(yClose - yOpen) || 1;

                        return (
                            <g key={i}>
                                <line x1={x + candleWidth/2} y1={yHigh} x2={x + candleWidth/2} y2={yLow} stroke={displayColor} strokeWidth="1" strokeLinecap="round"/>
                                <rect x={x} y={barTop} width={candleWidth} height={barHeight} fill={displayColor} rx="1" />
                            </g>
                        );
                    })}
                </svg>
                <div className="absolute right-0 top-0 bottom-0 flex flex-col justify-between text-[9px] text-ios-gray4 py-1 pointer-events-none">
                     <span>{maxPrice.toFixed(0)}</span>
                     <span>{minPrice.toFixed(0)}</span>
                </div>
            </div>
        );
    };

    // --- Mock Data & Networking ---
    const generateMockData = (code) => {
      const count = 60;
      const now = new Date();
      const timestamps = [];
      const closes = [], highs = [], lows = [], opens = [], vols = [];
      let price = (parseInt(code) || 100) % 500 + 50; 
      if (price < 10) price = 100;
      for(let i=0; i<count; i++) {
        const time = new Date(now);
        time.setDate(now.getDate() - (count - i));
        timestamps.push(Math.floor(time.getTime() / 1000));
        const change = (Math.random() - 0.5) * price * 0.05; 
        const open = price;
        const close = price + change;
        const high = Math.max(open, close) + Math.random() * price * 0.02;
        const low = Math.min(open, close) - Math.random() * price * 0.02;
        const vol = Math.floor(Math.random() * 5000 + 1000);
        opens.push(open); closes.push(close); highs.push(high); lows.push(low); vols.push(vol);
        price = close;
      }
      return { chart: { result: [{ meta: { currency: "TWD", symbol: `${code}.TW` }, timestamp: timestamps, indicators: { quote: [{ open: opens, high: highs, low: lows, close: closes, volume: vols }] } }] } };
    };
    const fetchWithProxy = async (targetUrl) => {
      const proxies = [(url) => `https://corsproxy.io/?${encodeURIComponent(url)}`, (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`];
      for (const proxyGen of proxies) {
        try {
          const res = await fetch(proxyGen(targetUrl));
          if (res.ok) return await res.json();
        } catch (e) { console.warn("Proxy failed", e); }
      }
      throw new Error("All proxies failed");
    };
    const fetchStockName = async (code) => {
      const tryFetch = async (type) => {
        try {
          const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${type}_${code}.tw&json=1&delay=0`;
          const data = await fetchWithProxy(url);
          if (data.msgArray && data.msgArray[0] && data.msgArray[0].n) return data.msgArray[0].n;
        } catch (e) { return null; }
      };
      let name = await tryFetch('tse');
      if (!name) name = await tryFetch('otc');
      return name || code;
    };

    // --- Components ---

    const ApiKeyModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
        const [tempKey, setTempKey] = useState(apiKey);
        useEffect(() => setTempKey(apiKey), [apiKey]);
        const handleSave = () => { setApiKey(tempKey); localStorage.setItem("gemini_api_key", tempKey); onClose(); };
        
        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/10 backdrop-blur-[2px] transition-all duration-300">
                <div className="bg-white/85 backdrop-blur-2xl rounded-[28px] shadow-ios-modal w-[280px] overflow-hidden animate-scale-in border border-white/40">
                    <div className="pt-6 pb-4 px-5 text-center">
                        <div className="mx-auto w-10 h-10 bg-gradient-to-tr from-ios-blue to-[#5AC8FA] rounded-full flex items-center justify-center mb-3 shadow-lg shadow-blue-500/20">
                            <Key size={18} className="text-white"/>
                        </div>
                        <h3 className="text-[17px] font-semibold text-black mb-1 tracking-tight">API 設定</h3>
                        <p className="text-[12px] leading-relaxed text-ios-gray">
                            請輸入您的 Gemini API Key<br/>以啟用 AI 戰略功能
                        </p>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-ios-blue text-[12px] font-medium mt-2 inline-block hover:opacity-70 transition-opacity">
                            取得免費 API Key &rarr;
                        </a>
                    </div>
                    <div className="px-5 pb-2">
                        <input 
                            type="password" 
                            value={tempKey}
                            onChange={(e) => setTempKey(e.target.value)}
                            placeholder="sk-..."
                            className="w-full px-3 py-2 bg-[rgba(118,118,128,0.12)] border-none rounded-[10px] text-[15px] focus:ring-0 text-center transition-colors placeholder-ios-gray3 text-black ios-input-shadow"
                        />
                    </div>
                    <div className="grid grid-cols-2 border-t border-gray-300/30 mt-4">
                        <button onClick={onClose} className="py-3 text-[16px] text-ios-blue font-normal border-r border-gray-300/30 hover:bg-black/5 active:bg-black/10 transition-colors">取消</button>
                        <button onClick={handleSave} className="py-3 text-[16px] text-ios-blue font-semibold hover:bg-black/5 active:bg-black/10 transition-colors">儲存</button>
                    </div>
                </div>
            </div>
        );
    };

    const StockCard = ({ code, onDelete, apiKey, openSettings }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [isMock, setIsMock] = useState(false);
      
      const [llmSummary, setLlmSummary] = useState(null);
      const [isLlmLoading, setIsLlmLoading] = useState(false);
      const [llmError, setLlmError] = useState(null);
      const [strategy, setStrategy] = useState(null);
      const [isStrategyLoading, setIsStrategyLoading] = useState(false);
      
      // New States for Features
      const [keyLevels, setKeyLevels] = useState(null);
      const [riskAssessment, setRiskAssessment] = useState(null);

      // Replaced individual toggle states with a single view mode
      const [activeTab, setActiveTab] = useState('none'); // 'none', 'chart', 'details'

      const fetchData = useCallback(async () => {
        setLoading(true); setError(null); setIsMock(false);
        try {
          let chartData = null; let stockName = code;
          try {
            const [chartRes, nameRes] = await Promise.allSettled([
              fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${code}.TW?interval=1d&range=3mo`),
              fetchStockName(code)
            ]);
            if (chartRes.status === 'fulfilled' && chartRes.value?.chart?.result) chartData = chartRes.value;
            else throw new Error("API fail");
            if (nameRes.status === 'fulfilled' && nameRes.value) stockName = nameRes.value;
          } catch (e) {
            chartData = generateMockData(code); stockName = `${code}`; setIsMock(true);
          }

          const result = chartData.chart?.result?.[0];
          const quote = result.indicators.quote[0];
          const closes = (quote.close || []).filter(n => typeof n === "number");
          const opens = (quote.open || []).filter(n => typeof n === "number");
          const highs = (quote.high || []).filter(n => typeof n === "number");
          const lows = (quote.low || []).filter(n => typeof n === "number");
          const vols = (quote.volume || []).filter(n => typeof n === "number");

          if (closes.length < 28) throw new Error("數據不足");

          const lastClose = lastValid(closes);
          const volume = lastValid(vols);
          
          const rsi14 = calcRSI(closes, 14);
          const rsi28 = calcRSI(closes, 28); 
          const ma20 = avgTail(closes, 20);
          const trend = (lastClose >= ma20) ? 1 : -1;
          const avgV10 = avgTail(vols, 10);
          const volStrength = (volume > avgV10 * 1.1) ? 1 : -1; 

          const { macd, signal, hist } = calcMACD(closes); 
          const fb = detectFalseBreakout(highs, lows, closes, vols);
          
          const marketTrend = 1; 

          const tech = (rsi14 < 40 && rsi28 < 45) ? 0.2 : (rsi14 > 70 && rsi28 > 65) ? 0.8 : 0.5;
          let score = (0.6 * tech) +
                      (0.2 * (trend === 1 ? 0.7 : 0.3)) +
                      (0.1 * (volStrength === 1 ? 0.7 : 0.3)) +
                      (0.1 * (marketTrend === 1 ? 0.7 : 0.3));

          score += (hist > 0 ? +0.05 : -0.05);
          if (fb.bear) score -= 0.15;
          if (fb.bull) score += 0.10;
          score = Math.max(0, Math.min(1, score));
          
          const conf = Math.round(score * 100);
          
          let signalText = "觀望";
          let signalType = "neutral";
          if (score <= 0.35) { signalText = "買進區"; signalType = "buy"; }
          else if (score >= 0.65) { signalText = "賣出區"; signalType = "sell"; }

          setData({
            name: stockName, code, price: lastClose,
            change: lastClose - closes[closes.length-2],
            rsi: rsi14.toFixed(1), conf, signal: signalText, signalType,
            details: { ma20, hist, macd, signalLine: signal, volume: lastValid(vols), fb, avgV10, volStrength },
            history: { opens, highs, lows, closes } 
          });
        } catch (err) { setError("無法讀取"); } 
        finally { setLoading(false); }
      }, [code]);

      useEffect(() => { fetchData(); }, [fetchData]);
      
      const runAI = async (type) => {
          if (!apiKey) {
              openSettings(); // Open the modal instead of alerting
              return;
          }
          
          // Reset states based on type to show loading correctly if needed
          if (type === 'news') { setIsLlmLoading(true); setLlmError(null); setLlmSummary(null); }
          else if (type === 'strategy') { setIsStrategyLoading(true); setStrategy(null); }
          else if (type === 'levels') { setIsStrategyLoading(true); setKeyLevels(null); }
          else if (type === 'risk') { setIsStrategyLoading(true); setRiskAssessment(null); }

          try {
              let prompt = "";
              let system = "你是一位專業簡潔的台股分析師";
              const isSearch = type === 'news';

              if (type === 'news') {
                  prompt = `簡述 ${data.name} (${data.code}) 近期重大財經新聞與財報重點 (50字內)。`;
              } else if (type === 'strategy') {
                  prompt = `基於 ${data.name} 技術面: 收盤${data.price}, RSI ${data.rsi}, MACD ${data.details.hist>0?'多':'空'}, 給出短線操作建議 (50字內, 勿免責聲明)。`;
              } else if (type === 'levels') {
                  const recentHigh = Math.max(...data.history.highs.slice(-20));
                  const recentLow = Math.min(...data.history.lows.slice(-20));
                  prompt = `你是台股技術分析師。請根據 ${data.name} (${data.code}) 的數據：收盤價 ${data.price}，近期最高價 ${recentHigh}，近期最低價 ${recentLow}。請預測短線的「關鍵支撐」與「關鍵壓力」價位。回答格式範例：支撐 100.0 / 壓力 110.0。字數 30 字內。`;
              } else if (type === 'risk') {
                  const macdStatus = data.details.hist > 0 ? '翻紅(多方)' : '翻綠(空方)';
                  prompt = `你是風險控管專家。根據 ${data.name} (${data.code}) 數據：RSI ${data.rsi}, MACD ${macdStatus}。請評估短線操作風險等級（低/中/高）並簡述原因。回答範例：風險：高 (RSI過熱)。字數 30 字內。`;
              }
              
              const res = await callGeminiApi(apiKey, prompt, system, isSearch);
              
              if (type === 'news') setLlmSummary(res);
              else if (type === 'strategy') setStrategy(res.text);
              else if (type === 'levels') setKeyLevels(res.text);
              else if (type === 'risk') setRiskAssessment(res.text);

          } catch (e) { 
              if (type === 'news') setLlmError(e.message);
              else alert(e.message); 
          } 
          finally { 
              setIsLlmLoading(false); 
              setIsStrategyLoading(false); 
          }
      };

      if (error) return (
        <div className="bg-ios-card rounded-[20px] p-4 mb-4 shadow-sm border border-ios-gray6 flex justify-between items-center">
            <span className="text-ios-red flex items-center gap-2 font-medium"><AlertCircle size={18}/> {code} 失敗</span>
            <button onClick={() => onDelete(code)} className="text-ios-gray4"><Trash2 size={18}/></button>
        </div>
      );

      const isUp = data?.change >= 0;
      const colorClass = isUp ? 'text-ios-red' : 'text-ios-green'; 

      let badgeBg = 'bg-ios-gray6 text-ios-gray';
      if(data?.signalType === 'buy') badgeBg = 'bg-ios-blue/10 text-ios-blue'; 
      if(data?.signalType === 'sell') badgeBg = 'bg-ios-red/10 text-ios-red';

      let ambientClass = "shadow-ios-card border border-transparent"; 
      if (data?.signalType === 'buy') {
          ambientClass = "shadow-[0_0_30px_-5px_rgba(0,122,255,0.3)] border border-ios-blue/30 ring-1 ring-ios-blue/20";
      } else if (data?.signalType === 'sell') {
          ambientClass = "shadow-[0_0_30px_-5px_rgba(255,59,48,0.3)] border border-ios-red/30 ring-1 ring-ios-red/20";
      }

      const toggleTab = (tab) => {
          if (activeTab === tab) setActiveTab('none');
          else setActiveTab(tab);
      };

      return (
        <div className={`bg-ios-card rounded-[22px] p-5 mb-5 animate-slide-up relative overflow-hidden transition-all active:scale-[0.99] duration-300 ${ambientClass}`}>
          {loading ? (
            <div className="flex justify-center py-8"><div className="w-6 h-6 border-2 border-ios-gray3 border-t-ios-blue rounded-full animate-spin"></div></div>
          ) : (
            <>
              {/* Header */}
              <div className="flex justify-between items-start mb-1">
                <div>
                  <div className="flex items-baseline gap-2">
                    <h3 className="text-[22px] font-bold text-black tracking-tight">{data.name}</h3>
                    <span className="text-[13px] font-semibold text-ios-gray2 bg-ios-gray6 px-1.5 py-0.5 rounded-md">{data.code}</span>
                  </div>
                </div>
                <div className={`px-3 py-1 rounded-full text-[13px] font-bold ${badgeBg}`}>
                  {data.signal}
                </div>
              </div>

              {/* Full Width Confidence Bar */}
              <div className="w-full h-1.5 mb-4 rounded-full overflow-hidden bg-ios-gray6 mt-3">
                <div 
                    className={`h-full transition-all duration-700 ease-out rounded-full ${data.signalType === 'buy' ? 'bg-ios-blue' : data.signalType === 'sell' ? 'bg-ios-red' : 'bg-ios-gray3'}`} 
                    style={{ width: `${data.conf}%` }}
                ></div>
              </div>

              {/* Price */}
              <div className="flex items-baseline gap-3 mb-5">
                <span className={`text-[34px] font-semibold tracking-tighter ${colorClass}`}>
                    {data.price.toFixed(2)}
                </span>
                <span className={`text-[17px] font-medium ${colorClass}`}>
                    {isUp ? '▲' : '▼'} {Math.abs(data.change).toFixed(2)}
                </span>
              </div>

              {/* Key Stats Row */}
              <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-ios-gray6/50 rounded-2xl p-3">
                      <div className="text-[11px] font-semibold text-ios-gray uppercase mb-0.5">RSI 強度</div>
                      <div className="text-[17px] font-semibold text-black">{data.rsi}</div>
                  </div>
                  <div className="bg-ios-gray6/50 rounded-2xl p-3">
                      <div className="text-[11px] font-semibold text-ios-gray uppercase mb-0.5">AI 信心分數</div>
                      <div className="text-[17px] font-semibold text-black">{data.conf} <span className="text-[11px] font-normal text-ios-gray">/ 100</span></div>
                  </div>
              </div>

              {/* Trend Tags */}
              <div className="flex flex-wrap gap-2 mb-4">
                  <span className={`px-3 py-1 rounded-full text-[11px] font-bold ${isUp ? 'bg-ios-red/10 text-ios-red' : 'bg-ios-green/10 text-ios-green'}`}>
                      {isUp ? '趨勢向上' : '趨勢向下'}
                  </span>
                  {data.details.hist > 0 ? 
                    <span className="px-3 py-1 rounded-full text-[11px] font-bold bg-ios-red/10 text-ios-red">MACD 多方</span> : 
                    <span className="px-3 py-1 rounded-full text-[11px] font-bold bg-ios-green/10 text-ios-green">MACD 空方</span>
                  }
                  {data.details.fb.bull && <span className="px-3 py-1 rounded-full text-[11px] font-bold bg-yellow-100 text-yellow-600">假跌破</span>}
                  {data.details.fb.bear && <span className="px-3 py-1 rounded-full text-[11px] font-bold bg-gray-200 text-gray-600">假突破</span>}
              </div>

              {/* AI Action Buttons Grid (4 Buttons) */}
              <div className="grid grid-cols-2 gap-3 mb-4">
                  {/* Row 1 */}
                  <button 
                    onClick={() => runAI('news')} disabled={isLlmLoading}
                    className="flex items-center justify-center gap-1.5 bg-ios-blue/10 active:bg-ios-blue/20 py-2.5 rounded-xl transition-colors"
                  >
                    {isLlmLoading && !isStrategyLoading ? <div className="w-4 h-4 border-2 border-ios-blue/30 border-t-ios-blue rounded-full animate-spin"/> : <Sparkles size={16} className="text-ios-blue"/>}
                    <span className="text-[13px] font-semibold text-ios-blue">新聞摘要</span>
                  </button>
                  <button 
                    onClick={() => runAI('strategy')} disabled={isStrategyLoading}
                    className="flex items-center justify-center gap-1.5 bg-ios-blue/10 active:bg-ios-blue/20 py-2.5 rounded-xl transition-colors"
                  >
                    {isStrategyLoading && !isLlmLoading ? <div className="w-4 h-4 border-2 border-ios-blue/30 border-t-ios-blue rounded-full animate-spin"/> : <Brain size={16} className="text-ios-blue"/>}
                    <span className="text-[13px] font-semibold text-ios-blue">AI 診斷</span>
                  </button>
                  
                  {/* Row 2 (New Features) */}
                  <button 
                    onClick={() => runAI('levels')} disabled={isStrategyLoading}
                    className="flex items-center justify-center gap-1.5 bg-ios-orange/10 active:bg-ios-orange/20 py-2.5 rounded-xl transition-colors"
                  >
                    <Target size={16} className="text-ios-orange"/>
                    <span className="text-[13px] font-semibold text-ios-orange">✨ 支撐壓力</span>
                  </button>
                  <button 
                    onClick={() => runAI('risk')} disabled={isStrategyLoading}
                    className="flex items-center justify-center gap-1.5 bg-ios-purple/10 active:bg-ios-purple/20 py-2.5 rounded-xl transition-colors"
                  >
                    <ShieldAlert size={16} className="text-ios-purple"/>
                    <span className="text-[13px] font-semibold text-ios-purple">✨ 風險評估</span>
                  </button>
              </div>

              {/* AI Result Area (Unified) */}
              {(llmSummary || strategy || keyLevels || riskAssessment) && (
                <div className="mb-4 bg-ios-gray6 rounded-xl p-3.5 animate-slide-up space-y-2">
                    {llmSummary && (
                        <div className="last:mb-0">
                            <div className="flex items-center gap-1.5 mb-1">
                                <Sparkles size={12} className="text-ios-gray"/>
                                <span className="text-[11px] font-bold text-ios-gray uppercase">新聞重點</span>
                            </div>
                            <p className="text-[14px] leading-relaxed text-black">{llmSummary.text}</p>
                        </div>
                    )}
                    {strategy && (
                        <div className="last:mb-0 pt-2 border-t border-gray-200/50">
                            <div className="flex items-center gap-1.5 mb-1">
                                <Brain size={12} className="text-ios-gray"/>
                                <span className="text-[11px] font-bold text-ios-gray uppercase">策略建議</span>
                            </div>
                            <p className="text-[14px] leading-relaxed text-black">{strategy}</p>
                        </div>
                    )}
                    {keyLevels && (
                        <div className="last:mb-0 pt-2 border-t border-gray-200/50">
                            <div className="flex items-center gap-1.5 mb-1">
                                <Target size={12} className="text-ios-orange"/>
                                <span className="text-[11px] font-bold text-ios-orange uppercase">關鍵價位</span>
                            </div>
                            <p className="text-[14px] leading-relaxed text-black font-medium">{keyLevels}</p>
                        </div>
                    )}
                    {riskAssessment && (
                        <div className="last:mb-0 pt-2 border-t border-gray-200/50">
                            <div className="flex items-center gap-1.5 mb-1">
                                <ShieldAlert size={12} className="text-ios-purple"/>
                                <span className="text-[11px] font-bold text-ios-purple uppercase">風險評估</span>
                            </div>
                            <p className="text-[14px] leading-relaxed text-black font-medium">{riskAssessment}</p>
                        </div>
                    )}
                </div>
              )}

              {/* IOS Segmented Control for Chart/Details */}
              <div className="mt-4">
                  <div className="flex bg-ios-gray6 p-1 rounded-[10px]">
                      <button 
                          onClick={() => toggleTab('chart')}
                          className={`flex-1 flex items-center justify-center gap-1.5 py-1.5 rounded-[8px] text-[13px] font-medium transition-all ${activeTab === 'chart' ? 'bg-white text-black shadow-sm' : 'text-ios-gray'}`}
                      >
                          <BarChart2 size={14}/> K線圖
                      </button>
                      <button 
                          onClick={() => toggleTab('details')}
                          className={`flex-1 flex items-center justify-center gap-1.5 py-1.5 rounded-[8px] text-[13px] font-medium transition-all ${activeTab === 'details' ? 'bg-white text-black shadow-sm' : 'text-ios-gray'}`}
                      >
                          <List size={14}/> 詳細數據
                      </button>
                  </div>
                  
                  {/* Footer Actions */}
                  <div className="flex justify-between items-center mt-2 px-1">
                      <div className="text-[11px] text-ios-gray3 flex items-center gap-1">
                          <Clock size={10}/> 資料日期: {data.date}
                      </div>
                      <div className="flex gap-4">
                          <button onClick={fetchData} className="text-ios-gray4 hover:text-ios-blue transition-colors flex items-center gap-1 text-[11px] font-medium"><RefreshCw size={12}/> 更新</button>
                          <button onClick={() => onDelete(code)} className="text-ios-gray4 hover:text-ios-red transition-colors flex items-center gap-1 text-[11px] font-medium"><Trash2 size={12}/> 移除</button>
                      </div>
                  </div>

                  {activeTab === 'details' && data.details && (
                    <div className="animate-slide-up mt-3 pt-3 border-t border-ios-gray6">
                        <div className="grid grid-cols-2 gap-4 py-2 text-[13px]">
                            <div>
                                <span className="text-ios-gray block mb-0.5">MA20 月線</span>
                                <span className="font-semibold text-black block">{data.details.ma20.toFixed(2)}</span>
                                <span className={`text-[11px] font-medium ${data.price > data.details.ma20 ? 'text-ios-red' : 'text-ios-green'}`}>
                                    {data.price > data.details.ma20 ? '股價在均線上' : '股價在均線下'}
                                </span>
                            </div>
                            <div>
                                <span className="text-ios-gray block mb-0.5">成交量</span>
                                <span className={`font-semibold ${data.details.volStrength === 1 ? 'text-ios-red' : 'text-ios-green'}`}>
                                    {(data.details.volume/1000).toFixed(1)}張
                                </span>
                            </div>
                            <div>
                                <span className="text-ios-gray block mb-0.5">MACD</span>
                                <span className="font-semibold text-black">{data.details.macd.toFixed(2)}</span>
                            </div>
                            <div>
                                <span className="text-ios-gray block mb-0.5">訊號線 (9EMA)</span>
                                <span className="font-semibold text-black">{data.details.signalLine.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div className="mt-2 p-3 bg-ios-gray6/50 rounded-xl">
                            <div className="text-[11px] font-semibold text-ios-gray uppercase mb-1">MACD 動能判斷</div>
                            <div className={`font-bold text-[13px] ${data.details.hist > 0 ? 'text-ios-red' : 'text-ios-green'}`}>
                                {data.details.macd > data.details.signalLine ? '黃金交叉' : '死亡交叉'} / 柱狀線 {data.details.hist > 0 ? '擴大' : '縮小'}
                            </div>
                        </div>
                    </div>
                 )}

                 {activeTab === 'chart' && data.history && (
                     <div className="animate-slide-up mt-3 pb-2 border-b border-ios-gray6 mb-2">
                         <CandlestickChart data={data.history} />
                     </div>
                 )}
              </div>

            </>
          )}
        </div>
      );
    };

    const App = () => {
      const [inputCode, setInputCode] = useState("");
      const [stocks, setStocks] = useState(() => JSON.parse(localStorage.getItem("myStocks")) || ["2330", "2603"]);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem("gemini_api_key") || "");
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);

      useEffect(() => localStorage.setItem("myStocks", JSON.stringify(stocks)), [stocks]);

      const addStock = (e) => {
        e.preventDefault();
        const code = inputCode.trim();
        if (code && !stocks.includes(code)) {
          setStocks(prev => [code, ...prev]);
          setInputCode("");
        }
      };

      return (
        <div className="min-h-screen pb-20">
          {/* iOS Style Navigation Bar */}
          <div className="sticky top-0 z-20 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-gray-200/50 pt-safe-top">
            <div className="max-w-md mx-auto px-5 pt-12 pb-2 flex justify-between items-end">
              <h1 className="text-[34px] font-bold text-black tracking-tight leading-none">
                阿彬日記
              </h1>
              <button onClick={() => setIsSettingsOpen(true)} className="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center text-ios-blue mb-1">
                  <Settings size={20}/>
              </button>
            </div>
            
            {/* Search Bar */}
            <div className="max-w-md mx-auto px-5 pb-4">
                <form onSubmit={addStock} className="relative">
                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                        <Plus size={18} className="text-ios-gray rotate-45"/>
                    </div>
                    <input 
                        type="text" 
                        value={inputCode}
                        onChange={(e) => setInputCode(e.target.value)}
                        placeholder="搜尋股票代號 (如 2330)"
                        className="w-full bg-ios-gray5/80 hover:bg-ios-gray5 focus:bg-white text-black text-[17px] rounded-[10px] py-2 pl-9 pr-4 outline-none transition-all placeholder-ios-gray"
                    />
                </form>
            </div>
          </div>

          <div className="max-w-md mx-auto px-5 pt-6 space-y-4">
            {stocks.length === 0 && (
                <div className="text-center py-20">
                    <p className="text-ios-gray text-[17px]">無自選股</p>
                </div>
            )}
            
            {stocks.map(code => (
                <StockCard 
                    key={code} 
                    code={code} 
                    onDelete={code => setStocks(s => s.filter(x => x !== code))} 
                    apiKey={apiKey} 
                    openSettings={() => setIsSettingsOpen(true)} // Add this
                />
            ))}

            <div className="text-center text-[11px] text-ios-gray3 mt-10 pb-10">
                <p>資料來源：Yahoo Finance (延遲) • 僅供參考</p>
            </div>
          </div>

          <ApiKeyModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} apiKey={apiKey} setApiKey={setApiKey} />
        </div>
      );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
</body>
</html>
